<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Destinos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #f5f5f5; }
    header { background: #111827; color: #f9fafb; padding: 14px 20px; }
    header h1 { margin: 0; font-size: 18px; }
    .container { padding: 18px 20px 32px; }

    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 12px; margin-bottom: 20px; }
    .card { background: #ffffff; border-radius: 8px; padding: 10px 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .card h3 { margin: 0 0 4px; font-size: 13px; color: #4b5563; }
    .card p { margin: 0; font-size: 18px; font-weight: 600; color: #111827; }

    .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap: 20px; margin-bottom: 20px; }
    .chart-box { background: #ffffff; border-radius: 8px; padding: 10px 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .chart-box h3 { margin: 0 0 6px; font-size: 13px; color: #374151; }

    .analysis-section { background: #ffffff; border-radius: 8px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .analysis-header { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .analysis-header select { padding: 4px 6px; font-size: 13px; }
    .analysis-output { margin-top: 8px; padding-top: 6px; border-top: 1px solid #e5e7eb; max-height: 380px; overflow-y: auto; white-space: normal; font-size: 13px; line-height: 1.35; }

    .block {
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .services-list { margin-top: 6px; font-size: 12px; }
    .services-list span {
      display: inline-block;
      margin: 2px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #374151;
    }

    .error { color: #b91c1c; background:#fee2e2; padding:8px; border-radius:6px; margin-top:10px; font-size:13px; display:none; }

        .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 14px;
    }

  </style>
</head>
<body>

<header>
  <h1>Dashboard de destinos (Booking)</h1>
</header>

<div class="container">
  <div id="summary-cards" class="cards"></div>

  <div class="charts">
    <div class="chart-box">
      <h3>Puntaje promedio por destino (weighted_score)</h3>
      <canvas id="scoreChart"></canvas>
    </div>
    <div class="chart-box">
      <h3>Puntaje promedio por destino (pointService)</h3>
      <canvas id="serviceChart"></canvas>
    </div>
    <div class="chart-box">
      <h3>Número de hoteles por destino</h3>
      <canvas id="hotelesChart"></canvas>
    </div>
    <div class="chart-box">
      <h3>Precio promedio por destino</h3>
      <canvas id="priceChart"></canvas>
    </div>
  </div>

  <div class="analysis-section">
    <div class="analysis-header">
      <label for="destinoSelect">Análisis GPT por destino:</label>
      <select id="destinoSelect"></select>
    </div>

    <div id="servicesDestino" class="services-list"></div>
    <div id="analysisOutput" class="analysis-output"></div>

    <div id="errorBox" class="error"></div>
  </div>
</div>

<script>
/* ==============================
   Render Markdown Básico
================================ */
function renderMarkdown(md) {
  if (!md) return "";

  let html = md.trim();

  html = html.replace(/^### (.*)$/gm, "<h3>$1</h3>");
  html = html.replace(/^## (.*)$/gm, "<h3>$1</h3>");
  html = html.replace(/^# (.*)$/gm, "<h2>$1</h2>");

  html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
  html = html.replace(/^- (.*)$/gm, "• $1");

  html = html.replace(/\n{2,}/g, "<br><br>");
  html = html.replace(/\n/g, "<br>");

  return html;
}

/* ==============================
   Separar GPT en bloques
================================ */
function splitInBlocks(mdText) {
  if (!mdText) return [];

  const blocks = mdText.split(/(?:\r?\n)+###\s*/g).map((block, index) => {
    if (index === 0) return block.trim();
    return "### " + block.trim();
  });

  return blocks;
}

/* ==============================
   Cargar JSON
================================ */
fetch("analisis_destinos.json")
  .then(res => res.text())
  .then(text => {
    let data;

    try {
      data = JSON.parse(text);
    } catch(e) {
      document.getElementById("errorBox").style.display = "block";
      document.getElementById("errorBox").textContent = "Error leyendo JSON: " + e.message;
      return;
    }

    const destinos = Array.isArray(data) ? data : [data];
    initDashboard(destinos);
  })
  .catch(err => {
    const box = document.getElementById("errorBox");
    box.style.display = "block";
    box.textContent = "Error cargando JSON: " + err.message;
  });

/* ==============================
   Dashboard
================================ */
function initDashboard(destinos) {
  const sum = arr => arr.reduce((a,b)=>a+b,0);
  const avg = arr => arr.length ? sum(arr)/arr.length : 0;

  // --- Cards ---
  const cardsContainer = document.getElementById("summary-cards");

  const totalDestinos = destinos.length;
  const totalHoteles = sum(destinos.map(d => d.n_hoteles || 0));
  const totalReviews = sum(destinos.map(d => d.nreviews || 0));
  const avgScore = avg(destinos.map(d => d.weighted_score || 0));
  const avgService = avg(destinos.map(d => d.pointService || 0));

  const cards = [
    { title: "Destinos analizados", value: totalDestinos },
    { title: "Hoteles totales", value: totalHoteles },
    { title: "Reseñas totales", value: totalReviews },
    { title: "Puntaje medio global(weighted)", value: avgScore.toFixed(2) },
    { title: "Puntaje medios globales", value: avgService.toFixed(2) }
  ];

  cards.forEach(c => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<h3>${c.title}</h3><p>${c.value}</p>`;
    cardsContainer.appendChild(div);
  });

  // --- Charts ---
  const labels = destinos.map(d => d.destino);
  const scores = destinos.map(d => d.weighted_score || 0);
  const services = destinos.map(d => d.pointService || 0);
  const hoteles = destinos.map(d => d.n_hoteles || 0);
  const prices = destinos.map(d => d.price_num || 0);

  function makeBar(canvas, data) {
    new Chart(document.getElementById(canvas), {
      type: "bar",
      data: { labels, datasets: [{ data }] },
      options: { plugins: { legend: { display: false } } }
    });
  }

  makeBar("scoreChart", scores);
  makeBar("serviceChart", services);
  makeBar("hotelesChart", hoteles);
  makeBar("priceChart", prices);

  // --- Análisis GPT ---
  const select = document.getElementById("destinoSelect");
  const analysisOutput = document.getElementById("analysisOutput");
  const servicesDestino = document.getElementById("servicesDestino");

  destinos.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d.destino;
    opt.textContent = d.destino;
    select.appendChild(opt);
  });

  function updateAnalysis() {
    const d = destinos.find(x => x.destino === select.value);
    if (!d) return;

    const blocks = splitInBlocks(d.analisis_gpt || "");

    let html = "";

    blocks.forEach(block => {
      html += `<div class="block">${renderMarkdown(block)}</div>`;
    });

    analysisOutput.innerHTML = `
  <div class="analysis-grid">
    ${html}
  </div>
`;
    let servHtml = "";
    if (d.services) {
      Object.entries(d.services)
        .sort((a,b)=>b[1]-a[1])
        .forEach(([k,v])=>{
          servHtml += `<span>${k}: ${v}</span>`;
        });
    }
    servicesDestino.innerHTML = servHtml;
  }

  select.addEventListener("change", updateAnalysis);
  updateAnalysis();
}
</script>

</body>
</html>
